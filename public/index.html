<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#075E54">
  <title>TICO-bot Panel</title>
  <link rel="manifest" href="/manifest.json">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--wa-green:#075E54;--wa-light:#25D366;--wa-bg:#ECE5DD;--wa-dark:#1F2C34;--danger:#E74C3C;--success:#27AE60}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--wa-bg);min-height:100vh}
    #login{position:fixed;inset:0;background:linear-gradient(135deg,var(--wa-green),var(--wa-dark));display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000}
    #login.hidden{display:none}
    .logo{font-size:4rem;margin-bottom:1rem}
    .title{color:#fff;font-size:1.5rem;margin-bottom:2rem}
    .pin-box{display:flex;gap:.5rem;margin-bottom:1.5rem}
    .pin-digit{width:50px;height:60px;font-size:1.5rem;text-align:center;border:2px solid rgba(255,255,255,.3);border-radius:12px;background:rgba(255,255,255,.1);color:#fff;outline:none}
    .pin-digit:focus{border-color:var(--wa-light)}
    .login-btn{background:var(--wa-light);color:#fff;border:none;padding:1rem 3rem;font-size:1.1rem;border-radius:25px;cursor:pointer}
    .login-btn:disabled{opacity:.5}
    .error{color:#FF6B6B;margin-top:1rem}
    header{background:var(--wa-green);color:#fff;padding:1rem;position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center}
    .stats{display:flex;gap:1rem;font-size:.85rem}
    .badge{background:rgba(255,255,255,.2);padding:.3rem .6rem;border-radius:12px}
    .tabs{display:flex;background:#fff;border-bottom:1px solid #ddd;position:sticky;top:56px;z-index:99}
    .tab{flex:1;padding:.8rem;text-align:center;border:none;background:none;font-size:.9rem;color:#666;cursor:pointer;border-bottom:3px solid transparent}
    .tab.active{color:var(--wa-green);border-bottom-color:var(--wa-green);font-weight:600}
    .tab-badge{background:var(--danger);color:#fff;font-size:.7rem;padding:.15rem .4rem;border-radius:10px;margin-left:.3rem}
    .content{display:none;padding:1rem;padding-bottom:100px}
    .content.active{display:block}
    .card{background:#fff;border-radius:12px;padding:1rem;margin-bottom:1rem;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .card-header{display:flex;justify-content:space-between;margin-bottom:.8rem}
    .phone{font-weight:600;color:var(--wa-green)}
    .time{font-size:.8rem;color:#999}
    .details{background:var(--wa-bg);padding:.8rem;border-radius:8px;margin-bottom:1rem;font-size:.9rem}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
    .btn{padding:.8rem;border:none;border-radius:8px;font-size:.9rem;font-weight:600;cursor:pointer}
    .btn:active{transform:scale(.95)}
    .btn-price{background:var(--wa-light);color:#fff;grid-column:span 2}
    .btn-no{background:var(--danger);color:#fff}
    .btn-cat{background:#34B7F1;color:#fff}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:flex-end;z-index:200;opacity:0;visibility:hidden;transition:all .3s}
    .modal-bg.active{opacity:1;visibility:visible}
    .modal{background:#fff;width:100%;border-radius:20px 20px 0 0;padding:1.5rem;transform:translateY(100%);transition:transform .3s}
    .modal-bg.active .modal{transform:translateY(0)}
    .modal-title{font-size:1.2rem;font-weight:600;margin-bottom:1rem;text-align:center}
    .modal-client{background:var(--wa-bg);padding:.8rem;border-radius:8px;margin-bottom:1rem;text-align:center}
    .input-group{margin-bottom:1rem}
    .input-group label{display:block;font-size:.85rem;color:#666;margin-bottom:.3rem}
    .price-input{width:100%;padding:1rem;font-size:1.5rem;border:2px solid #ddd;border-radius:12px;text-align:center;outline:none}
    .price-input:focus{border-color:var(--wa-green)}
    .quick{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem}
    .quick button{padding:.5rem 1rem;background:var(--wa-bg);border:none;border-radius:20px;cursor:pointer}
    .modal-btns{display:flex;gap:.5rem}
    .modal-btn{flex:1;padding:1rem;border:none;border-radius:12px;font-size:1rem;font-weight:600;cursor:pointer}
    .modal-btn.cancel{background:#eee;color:#666}
    .modal-btn.ok{background:var(--wa-light);color:#fff}
    .metrics{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .metric{background:#fff;padding:1.2rem;border-radius:12px;text-align:center}
    .metric-val{font-size:2rem;font-weight:700;color:var(--wa-green)}
    .metric-label{font-size:.85rem;color:#666;margin-top:.3rem}
    .metric.big{grid-column:span 2;background:linear-gradient(135deg,var(--wa-green),var(--wa-dark));color:#fff}
    .metric.big .metric-val,.metric.big .metric-label{color:#fff}
    .empty{text-align:center;padding:3rem 1rem;color:#999}
    .empty-icon{font-size:4rem;margin-bottom:1rem}
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--wa-dark);color:#fff;padding:1rem 1.5rem;border-radius:12px;opacity:0;transition:all .3s;z-index:300}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    .toast.ok{background:var(--success)}
    .toast.err{background:var(--danger)}
  </style>
</head>
<body>
  <div id="login">
    <div class="logo">ü§ñ</div>
    <h1 class="title">TICO-bot Panel</h1>
    <div class="pin-box">
      <input type="tel" class="pin-digit" maxlength="1" inputmode="numeric">
      <input type="tel" class="pin-digit" maxlength="1" inputmode="numeric">
      <input type="tel" class="pin-digit" maxlength="1" inputmode="numeric">
      <input type="tel" class="pin-digit" maxlength="1" inputmode="numeric">
    </div>
    <button class="login-btn" id="loginBtn" disabled>Entrar</button>
    <p class="error" id="loginErr"></p>
  </div>

  <div id="app" style="display:none">
    <header>
      <div id="storeName">TICO-bot</div>
      <div class="stats">
        <span class="badge">üéüÔ∏è <span id="tokens">0</span></span>
        <span class="badge" id="status">üî¥</span>
      </div>
    </header>
    <div class="tabs">
      <button class="tab active" data-tab="pending">üì• Pendientes <span class="tab-badge" id="pendingBadge" style="display:none">0</span></button>
      <button class="tab" data-tab="metrics">üìä M√©tricas</button>
    </div>
    <div class="content active" id="tab-pending">
      <div id="pendingList"></div>
      <div class="empty" id="emptyPending"><div class="empty-icon">‚úÖ</div><p>¬°No hay pendientes!</p></div>
    </div>
    <div class="content" id="tab-metrics">
      <div class="metrics">
        <div class="metric big"><div class="metric-val" id="mTokens">0/0</div><div class="metric-label">Fichas</div></div>
        <div class="metric"><div class="metric-val" id="mChats">0</div><div class="metric-label">Chats</div></div>
        <div class="metric"><div class="metric-val" id="mQuotes">0</div><div class="metric-label">Cotizaciones</div></div>
        <div class="metric"><div class="metric-val" id="mSales">0</div><div class="metric-label">Ventas</div></div>
        <div class="metric"><div class="metric-val" id="mYes">0</div><div class="metric-label">Dijeron S√ç</div></div>
      </div>
    </div>
  </div>

  <div class="modal-bg" id="priceModal">
    <div class="modal">
      <div class="modal-title">üí∞ Enviar Precio</div>
      <div class="modal-client" id="modalClient">506XXXXXXXX</div>
      <div class="input-group">
        <label>Precio (‚Ç°)</label>
        <input type="number" class="price-input" id="inputPrice" placeholder="0" inputmode="numeric">
      </div>
      <div class="input-group">
        <label>Env√≠o (‚Ç°)</label>
        <input type="number" class="price-input" id="inputShip" placeholder="0" inputmode="numeric" style="font-size:1.2rem">
      </div>
      <div class="quick">
        <button data-p="5000">‚Ç°5,000</button>
        <button data-p="7500">‚Ç°7,500</button>
        <button data-p="10000">‚Ç°10,000</button>
        <button data-p="15000">‚Ç°15,000</button>
      </div>
      <div class="modal-btns">
        <button class="modal-btn cancel" id="modalCancel">Cancelar</button>
        <button class="modal-btn ok" id="modalOk">Enviar ‚úì</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let socket,pending=[],current=null;
    const $=id=>document.getElementById(id);
    const pins=document.querySelectorAll('.pin-digit');

    pins.forEach((p,i)=>{
      p.addEventListener('input',e=>{if(e.target.value&&i<3)pins[i+1].focus();checkPin()});
      p.addEventListener('keydown',e=>{if(e.key==='Backspace'&&!e.target.value&&i>0)pins[i-1].focus()});
    });

    function getPin(){return Array.from(pins).map(p=>p.value).join('')}
    function checkPin(){$('loginBtn').disabled=getPin().length!==4}

    $('loginBtn').onclick=()=>{
      socket=io();
      socket.on('connect',()=>socket.emit('auth',getPin()));
      socket.on('auth_success',d=>{
        $('login').classList.add('hidden');
        $('app').style.display='block';
        $('storeName').textContent=d.storeName||'TICO-bot';
        $('status').textContent='üü¢';
        toast('¬°Conectado! üôå','ok');
      });
      socket.on('auth_error',m=>{$('loginErr').textContent=m;pins.forEach(p=>p.value='');pins[0].focus()});
      socket.on('init_data',d=>{
        pending=d.pending||[];
        updateTokens(d.tokens);
        updateMetrics(d.metrics);
        render();
      });
      socket.on('new_pending',q=>{pending.push(q);render();playSound();toast('üì• Nueva consulta!','ok')});
      socket.on('pending_resolved',d=>{pending=pending.filter(p=>p.waId!==d.waId);render()});
      socket.on('action_result',r=>{r.success?toast('‚úÖ '+r.message,'ok'):toast('‚ùå '+r.message,'err');closeModal()});
      socket.on('disconnect',()=>$('status').textContent='üî¥');
      socket.on('metrics',d=>{updateTokens(d.tokens);updateMetrics(d.metrics)});
    };

    document.querySelectorAll('.tab').forEach(t=>{
      t.onclick=()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.content').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        $('tab-'+t.dataset.tab).classList.add('active');
        if(t.dataset.tab==='metrics')socket.emit('get_metrics');
      };
    });

    function render(){
      if(pending.length===0){
        $('pendingList').innerHTML='';
        $('emptyPending').style.display='block';
        $('pendingBadge').style.display='none';
      }else{
        $('emptyPending').style.display='none';
        $('pendingBadge').style.display='inline';
        $('pendingBadge').textContent=pending.length;
        $('pendingList').innerHTML=pending.map(p=>`
          <div class="card">
            <div class="card-header">
              <span class="phone">üì± ${fmtPhone(p.waId)}</span>
              <span class="time">${timeAgo(p.created_at)}</span>
            </div>
            <div class="details">üìù ${esc(p.details)}</div>
            <div class="actions">
              <button class="btn btn-price" onclick="openPrice('${p.waId}')">üí∞ Dar Precio</button>
              <button class="btn btn-no" onclick="send('${p.waId}','NO_HAY')">‚ùå No Hay</button>
              <button class="btn btn-cat" onclick="send('${p.waId}','CATALOGO')">üìã Cat√°logo</button>
            </div>
          </div>
        `).join('');
      }
    }

    function openPrice(waId){
      current=waId;
      $('modalClient').textContent=fmtPhone(waId);
      $('inputPrice').value='';
      $('inputShip').value='';
      $('priceModal').classList.add('active');
      $('inputPrice').focus();
    }

    function closeModal(){$('priceModal').classList.remove('active');current=null}

    $('modalCancel').onclick=closeModal;
    $('priceModal').onclick=e=>{if(e.target===$('priceModal'))closeModal()};

    $('modalOk').onclick=()=>{
      const price=parseInt($('inputPrice').value)||0;
      const ship=parseInt($('inputShip').value)||0;
      if(price<100){toast('‚ö†Ô∏è Precio inv√°lido','err');return}
      send(current,'PRECIO',{price,shipping:ship});
    };

    document.querySelectorAll('.quick button').forEach(b=>{
      b.onclick=()=>$('inputPrice').value=b.dataset.p;
    });

    function send(waId,type,payload={}){
      socket.emit('action',{clientWaId:waId,actionType:type,payload});
    }

    function updateTokens(t){
      if(!t)return;
      $('tokens').textContent=t.remaining;
      $('mTokens').textContent=t.remaining+'/'+t.total;
    }

    function updateMetrics(m){
      if(!m)return;
      $('mChats').textContent=m.chats_total||0;
      $('mQuotes').textContent=m.quotes_sent||0;
      $('mSales').textContent=m.sinpe_confirmed||0;
      $('mYes').textContent=m.intent_yes||0;
    }

    function fmtPhone(w){
      if(!w)return'';
      const d=w.replace(/\D/g,'');
      return d.length===11&&d.startsWith('506')?d.slice(3,7)+'-'+d.slice(7):w;
    }

    function timeAgo(d){
      if(!d)return'';
      const diff=Math.floor((Date.now()-new Date(d))/1000);
      if(diff<60)return'ahora';
      if(diff<3600)return Math.floor(diff/60)+'m';
      if(diff<86400)return Math.floor(diff/3600)+'h';
      return Math.floor(diff/86400)+'d';
    }

    function esc(s){return s?String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])):''}

    function toast(msg,type=''){
      const t=$('toast');
      t.textContent=msg;
      t.className='toast show '+(type||'');
      setTimeout(()=>t.classList.remove('show'),3000);
    }

    function playSound(){
      try{new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1f').play().catch(()=>{})}catch(e){}
    }

    pins[0].focus();
  </script>
</body>
</html>
